<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>小费分配 - TipOut</title>
  <link rel="stylesheet" href="common.css">
  <style>
    .date-range-group { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .day-tab-list {
      display: flex; gap: 0; overflow-x: auto; border-bottom: 1px solid var(--border-light);
      margin-bottom: 16px; padding-bottom: 4px; scrollbar-color: #c8c8c8 transparent;
    }
    .day-tab-list::-webkit-scrollbar { height: 6px; }
    .day-tab-list::-webkit-scrollbar-track { background: #f0f0f0; border-radius: 3px; }
    .day-tab-list::-webkit-scrollbar-thumb { background: #c0c0c0; border-radius: 3px; min-width: 40px; }
    .day-tab-list::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
    .day-tab {
      padding: 10px 16px; font-size: 13px; color: var(--text-secondary);
      border-bottom: 2px solid transparent; cursor: pointer; white-space: nowrap;
      transition: all 0.2s; text-align: center; min-width: 80px; flex-shrink: 0;
    }
    .day-tab:hover { color: var(--primary); }
    .day-tab.active { color: var(--primary); font-weight: 600; border-bottom-color: var(--primary); }
    .day-tab .day-status { font-size: 11px; margin-top: 2px; }
    .day-tab .day-status.allocated { color: var(--success); }
    .day-tab .day-status.pending { color: var(--warning); }
    #employeeResults { overflow-x: hidden; width: 100%; max-width: 100%; }
    .employee-section { margin-bottom: 24px; overflow-x: hidden; width: 100%; max-width: 100%; }
    .employee-section .data-table { width: 100%; table-layout: fixed; }
    .employee-section .data-table td,
    .employee-section .data-table th { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .employee-header {
      display: flex; align-items: center; gap: 12px; margin-bottom: 8px;
      padding-bottom: 8px; border-bottom: 1px solid var(--border-light);
    }
    .employee-name { font-size: 14px; font-weight: 600; }
    .fold-btn {
      border: none; background: none; cursor: pointer; color: var(--text-tertiary);
      font-size: 12px; display: flex; align-items: center; gap: 4px;
    }
    .fold-btn:hover { color: var(--primary); }
    .employee-detail { overflow: hidden; transition: max-height 0.3s; }
    .export-bar {
      position: fixed; bottom: 0; right: 0; left: 264px; z-index: 40;
      display: flex; justify-content: flex-end; padding: 12px 24px;
      background: #fff; border-top: 1px solid var(--border-light);
      box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
    }
    .content-area { padding-bottom: 72px; }
    @media (max-width: 768px) { .export-bar { left: 0; } }

    .export-dropdown { position: relative; }
    .export-menu {
      display: none; position: absolute; bottom: calc(100% + 8px); right: 0;
      background: #fff; border-radius: 8px; padding: 4px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08), 0 3px 6px -4px rgba(0,0,0,0.12), 0 9px 28px 8px rgba(0,0,0,0.05);
      min-width: 180px; z-index: 50;
    }
    .export-menu.show { display: block; }
    .export-menu-item {
      display: flex; align-items: center; gap: 10px;
      padding: 9px 14px; cursor: pointer; border-radius: 6px;
      font-size: 14px; transition: background 0.2s; white-space: nowrap;
    }
    .export-menu-item:hover { background: rgba(0,0,0,0.04); }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-logo">
        <div class="logo-icon">M</div>
        <span class="logo-text">MenuSifu</span>
      </div>
      <nav class="sidebar-menu">
        <div class="sidebar-submenu-title open" onclick="this.classList.toggle('open');this.nextElementSibling.style.maxHeight=this.classList.contains('open')?'200px':'0'">
          <span>Tip Out</span>
          <svg class="arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><path d="M6 8.825a.5.5 0 0 1-.354-.146l-4-4a.5.5 0 0 1 .708-.708L6 7.617l3.646-3.646a.5.5 0 0 1 .708.708l-4 4A.5.5 0 0 1 6 8.825z"/></svg>
        </div>
        <div class="sidebar-submenu-items" style="max-height:200px">
          <a href="index.html" class="sidebar-menu-item active">小费分配</a>
        </div>
      </nav>
    </aside>
    <div class="mobile-overlay"></div>
    <div class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
        </div>
        <div class="header-right">
          <div class="header-user">
            <div class="avatar">R</div>
            <span>Robert_W</span>
            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><path d="M6 8.825a.5.5 0 0 1-.354-.146l-4-4a.5.5 0 0 1 .708-.708L6 7.617l3.646-3.646a.5.5 0 0 1 .708.708l-4 4A.5.5 0 0 1 6 8.825z"/></svg>
          </div>
        </div>
      </header>

      <div class="page-tabs">
        <a href="index.html" class="page-tab active">小费分配</a>
        <a href="detail.html" class="page-tab">小费分配明细</a>
        <a href="rules.html" class="page-tab">小费分配规则</a>
      </div>

      <div class="content-area">
        <!-- Filters -->
        <div class="filter-bar" style="margin-bottom: 20px;">
          <div class="date-range-group">
            <input type="date" id="dateStart" class="form-control form-control-lg" value="2026-01-01" style="width:170px" onchange="renderDayTabs()">
            <span style="color:var(--text-tertiary)">~</span>
            <input type="date" id="dateEnd" class="form-control form-control-lg" value="2026-02-28" style="width:170px" onchange="renderDayTabs()">
          </div>
          <select id="storeSelect" class="form-control form-control-lg" style="width:460px" onchange="renderDayTabs()">
            <option value="">请选择门店</option>
          </select>
          <select class="form-control form-control-lg" style="width:150px">
            <option value="">All Role</option>
            <option>Assistant Manager</option>
            <option>Bartender</option>
            <option>Busser</option>
            <option>Cashier</option>
            <option>Driver</option>
            <option>Host</option>
            <option>Manager</option>
            <option>Runner</option>
            <option>Server</option>
            <option>Shift Lead</option>
          </select>
          <select class="form-control form-control-lg" style="width:150px">
            <option value="">All Staff</option>
            <option>Maria Garcia</option>
            <option>Jason Chen</option>
            <option>Emily Watson</option>
            <option>Diego Ramirez</option>
            <option>Mike Johnson</option>
            <option>Sarah Kim</option>
            <option>Carlos Lopez</option>
            <option>Tyler Brown</option>
            <option>Linda Nguyen</option>
            <option>Rachel Scott</option>
            <option>Daniel Ortiz</option>
            <option>Jessica Martinez</option>
            <option>Robert Williams</option>
          </select>
          <button id="allocateBtn" class="btn btn-primary btn-lg" onclick="doAllocateTips()">分配小费</button>
          <button class="btn btn-lg" onclick="doCancelAllocate()" style="color:var(--text-tertiary);font-size:13px" title="用于测试">取消分配</button>
        </div>

        <!-- Day Tabs — 根据筛选日期动态生成 -->
        <div class="day-tab-list" id="dayTabs"></div>

        <!-- 员工分配结果 — 根据筛选日期动态生成 -->
        <div id="employeeResults"></div>

      </div>

      <div class="export-bar">
        <div class="export-dropdown">
          <button class="btn btn-primary btn-lg" onclick="toggleExportMenu()">
            导出结果
            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor" style="margin-left:6px"><path d="M6 8.825a.5.5 0 0 1-.354-.146l-4-4a.5.5 0 0 1 .708-.708L6 7.617l3.646-3.646a.5.5 0 0 1 .708.708l-4 4A.5.5 0 0 1 6 8.825z"/></svg>
          </button>
          <div class="export-menu" id="exportMenu">
            <div class="export-menu-item" onclick="exportAs('pdf')">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink:0"><rect x="2" y="1" width="12" height="14" rx="2" stroke="#ff4d4f" stroke-width="1.2"/><text x="8" y="10.5" text-anchor="middle" fill="#ff4d4f" font-size="5" font-weight="600">PDF</text></svg>
              导出为 PDF
            </div>
            <div class="export-menu-item" onclick="exportAs('csv')">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink:0"><rect x="2" y="1" width="12" height="14" rx="2" stroke="#52c41a" stroke-width="1.2"/><text x="8" y="10.5" text-anchor="middle" fill="#52c41a" font-size="5" font-weight="600">CSV</text></svg>
              导出为 CSV
            </div>
            <div class="export-menu-item" onclick="openEmailModal()">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink:0"><rect x="1.5" y="3" width="13" height="10" rx="2" stroke="#1677ff" stroke-width="1.2"/><path d="M2 4l6 4 6-4" stroke="#1677ff" stroke-width="1.2" stroke-linecap="round"/></svg>
              发送到邮箱
            </div>
          </div>
        </div>
      </div>

      <!-- Email Modal -->
      <div class="modal-overlay" id="emailModal">
        <div class="modal" style="width:480px">
          <div class="modal-header">
            <h3>发送到邮箱</h3>
            <button class="modal-close" onclick="closeModal('emailModal')">×</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">收件邮箱</label>
              <input type="email" id="exportEmail" class="form-control" placeholder="请输入邮箱地址，多个邮箱用逗号分隔" style="width:100%">
            </div>
            <div class="form-group">
              <label class="form-label">导出格式</label>
              <div style="display:flex;gap:16px">
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px">
                  <input type="radio" name="emailFormat" value="pdf" checked style="accent-color:var(--primary)"> PDF
                </label>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px">
                  <input type="radio" name="emailFormat" value="csv" style="accent-color:var(--primary)"> CSV
                </label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" onclick="closeModal('emailModal')">取消</button>
            <button class="btn btn-primary" onclick="sendEmail()">发送</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="common.js"></script>
  <script src="ruleData.js"></script>
  <script>
    var ALLOC_KEY = 'tipout_allocated';
    function getAllocatedDates() {
      try {
        var store = (document.getElementById('storeSelect') || {}).value || '';
        var raw = localStorage.getItem(ALLOC_KEY);
        var obj = raw ? JSON.parse(raw) : {};
        var arr = obj[store] || [];
        return new Set(arr);
      } catch (e) { return new Set(); }
    }
    function saveAllocatedDates(dates) {
      var store = (document.getElementById('storeSelect') || {}).value || '';
      var raw = localStorage.getItem(ALLOC_KEY);
      var obj = raw ? JSON.parse(raw) : {};
      obj[store] = Array.from(dates);
      localStorage.setItem(ALLOC_KEY, JSON.stringify(obj));
    }

    const employees = [
      { name: 'Maria Garcia',  role: 'Server',    tagClass: 'tag-blue',  tipType: 'deduct', baseTip: 185, tipRate: 0.15 },
      { name: 'Jason Chen',    role: 'Server',    tagClass: 'tag-blue',  tipType: 'deduct', baseTip: 168, tipRate: 0.15 },
      { name: 'Emily Watson',  role: 'Server',    tagClass: 'tag-blue',  tipType: 'deduct', baseTip: 155, tipRate: 0.15 },
      { name: 'Diego Ramirez', role: 'Server',    tagClass: 'tag-blue',  tipType: 'deduct', baseTip: 142, tipRate: 0.15 },
      { name: 'Mike Johnson',  role: 'Bartender', tagClass: 'tag-blue',  tipType: 'deduct', baseTip: 156, tipRate: 0.15 },
      { name: 'Sarah Kim',     role: 'Bartender', tagClass: 'tag-blue',  tipType: 'deduct', baseTip: 138, tipRate: 0.15 },
      { name: 'Carlos Lopez',  role: 'Busser',    tagClass: 'tag-green', tipType: 'receive', baseTip: 0, tipRate: 0 },
      { name: 'Tyler Brown',   role: 'Busser',    tagClass: 'tag-green', tipType: 'receive', baseTip: 0, tipRate: 0 },
      { name: 'Linda Nguyen',  role: 'Cashier',   tagClass: 'tag-orange',tipType: 'deduct', baseTip: 45, tipRate: 0.15 },
      { name: 'Daniel Ortiz',  role: 'Runner',    tagClass: 'tag-green', tipType: 'receive', baseTip: 0, tipRate: 0 },
      { name: 'Rachel Scott',  role: 'Host',      tagClass: 'tag-green', tipType: 'receive', baseTip: 0, tipRate: 0 }
    ];

    function pad(n) { return n < 10 ? '0' + n : '' + n; }
    function formatDateKey(d) { return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()); }
    function formatTabLabel(d) { return pad(d.getMonth() + 1) + '/' + pad(d.getDate()); }
    function money(v) { return (v < 0 ? '-' : '') + '$' + Math.abs(v).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
    function moneySign(v) { return (v >= 0 ? '+' : '-') + '$' + Math.abs(v).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }

    function seedRandom(seed) {
      let s = seed;
      return function() { s = (s * 16807 + 0) % 2147483647; return (s - 1) / 2147483646; };
    }

    function genDailyTip(emp, dateKey) {
      const seed = dateKey.split('-').reduce((a, b) => a * 31 + parseInt(b), 0) + emp.name.length * 7 + emp.name.charCodeAt(0);
      const rng = seedRandom(seed);
      const dayOfWeek = new Date(dateKey + 'T00:00:00').getDay();
      const weekendBoost = (dayOfWeek === 5 || dayOfWeek === 6) ? 1.35 : 1.0;

      if (emp.tipType === 'deduct') {
        const before = +(emp.baseTip * (0.8 + rng() * 0.5) * weekendBoost).toFixed(2);
        const deducted = +(before * emp.tipRate).toFixed(2);
        return { date: dateKey, before: before, allocated: -deducted, after: +(before - deducted).toFixed(2) };
      } else {
        const poolShare = +(25 + rng() * 45) * weekendBoost;
        return { date: dateKey, before: 0, allocated: +poolShare.toFixed(2), after: +poolShare.toFixed(2) };
      }
    }

    function getDateRange() {
      const s = document.getElementById('dateStart').value;
      const e = document.getElementById('dateEnd').value;
      if (!s || !e) return [];
      const start = new Date(s + 'T00:00:00');
      const end = new Date(e + 'T00:00:00');
      if (isNaN(start) || isNaN(end) || start > end) return [];
      const dates = [];
      const cur = new Date(start);
      while (cur <= end) {
        dates.push(formatDateKey(cur));
        cur.setDate(cur.getDate() + 1);
      }
      return dates;
    }

    function renderDayTabs() {
      var dates = getDateRange();
      var allocatedDates = getAllocatedDates();
      var container = document.getElementById('dayTabs');
      container.innerHTML = '';
      dates.forEach(function(key, i) {
        var d = new Date(key + 'T00:00:00');
        var label = formatTabLabel(d);
        var isPending = !allocatedDates.has(key);
        var tab = document.createElement('div');
        tab.className = 'day-tab' + (i === 0 ? ' active' : '');
        tab.setAttribute('data-date', key);
        tab.setAttribute('data-pending', isPending ? '1' : '0');
        tab.onclick = function() { selectDay(this); };
        tab.innerHTML = '<div>' + label + '</div><div class="day-status ' +
          (isPending ? 'pending' : 'allocated') + '">' +
          (isPending ? '待分配' : '已分配') + '</div>';
        container.appendChild(tab);
      });
      updateAllocateButton();
      renderEmployeeResults();
    }

    function updateAllocateButton() {
      var dates = getDateRange();
      var allocatedDates = getAllocatedDates();
      var hasAllocated = dates.some(function(k) { return allocatedDates.has(k); });
      var btn = document.getElementById('allocateBtn');
      if (btn) btn.textContent = hasAllocated ? '重新分配小费' : '分配小费';
    }

    function hasTipRules() {
      return window.ruleData && ruleData.getRules && ruleData.getRules().length > 0;
    }

    function doAllocateTips() {
      if (!hasTipRules()) {
        showNotification('请先创建小费分配规则', 'error');
        setTimeout(function() { window.location.href = 'rules.html'; }, 1500);
        return;
      }
      var dates = getDateRange();
      var allocatedDates = getAllocatedDates();
      dates.forEach(function(k) { allocatedDates.add(k); });
      saveAllocatedDates(allocatedDates);
      renderDayTabs();
      showNotification('小费分配完成', 'success');
    }

    function doCancelAllocate() {
      var dates = getDateRange();
      var allocatedDates = getAllocatedDates();
      dates.forEach(function(k) { allocatedDates.delete(k); });
      saveAllocatedDates(allocatedDates);
      renderDayTabs();
      showNotification('已取消分配，状态已恢复为待分配', 'info');
    }

    function renderEmployeeResults() {
      var dates = getDateRange();
      var allocatedDates = getAllocatedDates();
      var container = document.getElementById('employeeResults');
      container.innerHTML = '';

      var hasAllocated = dates.some(function(k) { return allocatedDates.has(k); });
      if (!hasAllocated) {
        container.innerHTML = '<div style="padding:48px;text-align:center;color:var(--text-secondary);font-size:14px">暂无分配结果，请先点击「分配小费」完成分配</div>';
        return;
      }

      employees.forEach(function(emp, idx) {
        var dailyData = [];
        dates.forEach(function(dateKey) {
          if (allocatedDates.has(dateKey)) {
            dailyData.push(genDailyTip(emp, dateKey));
          }
        });

        if (dailyData.length === 0) return;

        const totalBefore = dailyData.reduce(function(s, d) { return s + d.before; }, 0);
        const totalAlloc = dailyData.reduce(function(s, d) { return s + d.allocated; }, 0);
        const totalAfter = dailyData.reduce(function(s, d) { return s + d.after; }, 0);

        const empId = 'emp_' + idx;
        const rows = dailyData.map(function(d) {
          return '<tr><td>' + d.date + '</td><td>' + money(d.before) + '</td><td>' +
            moneySign(d.allocated) + '</td><td>' + money(d.after) + '</td></tr>';
        }).join('');

        const section = document.createElement('div');
        section.className = 'employee-section';
        section.id = empId;
        section.innerHTML =
          '<div class="employee-header">' +
            '<span class="employee-name">' + emp.name + '</span>' +
            '<span class="tag ' + emp.tagClass + '">' + emp.role + '</span>' +
            '<button class="fold-btn" onclick="toggleFold(\'' + empId + '\')">' +
              '<span>收起</span>' +
              '<svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><path d="M6 3.175a.5.5 0 0 1 .354.146l4 4a.5.5 0 0 1-.708.708L6 4.383 2.354 8.029a.5.5 0 0 1-.708-.708l4-4A.5.5 0 0 1 6 3.175z"/></svg>' +
            '</button>' +
          '</div>' +
          '<div class="summary-row" style="margin-bottom:12px">' +
            '<span>分配前总小费：<strong>' + money(totalBefore) + '</strong></span>' +
            '<span>被分配总小费：<strong>' + moneySign(totalAlloc) + '</strong></span>' +
            '<span>分配后总小费：<strong>' + money(totalAfter) + '</strong></span>' +
          '</div>' +
          '<div class="employee-detail">' +
            '<table class="data-table">' +
              '<thead><tr><th>日期</th><th>分配前小费</th><th>被分配小费</th><th>分配后小费</th></tr></thead>' +
              '<tbody>' + rows + '</tbody>' +
            '</table>' +
          '</div>';
        container.appendChild(section);
      });
    }

    function selectDay(el) {
      var isPending = el.getAttribute('data-pending') === '1';
      if (isPending && !hasTipRules()) {
        showNotification('请先创建小费分配规则', 'error');
        setTimeout(function() { window.location.href = 'rules.html'; }, 1500);
        return;
      }
      document.querySelectorAll('.day-tab').forEach(function(t) { t.classList.remove('active'); });
      el.classList.add('active');
    }

    function toggleFold(empId) {
      const section = document.getElementById(empId);
      const detail = section.querySelector('.employee-detail');
      const btn = section.querySelector('.fold-btn span');
      if (detail.style.maxHeight === '0px') { detail.style.maxHeight = '2000px'; btn.textContent = '收起'; }
      else { detail.style.maxHeight = '0px'; btn.textContent = '展开'; }
    }

    function initStoreSelect() {
      var sel = document.getElementById('storeSelect');
      if (!sel) return;
      var rules = window.ruleData && ruleData.getRules ? ruleData.getRules() : [];
      var seen = {};
      var stores = [];
      rules.forEach(function(r) {
        var s = (r.store || '').trim();
        if (s && !seen[s]) { seen[s] = 1; stores.push(s); }
      });
      sel.innerHTML = '<option value="">请选择门店</option>' + stores.map(function(s) {
        return '<option value="' + s + '">' + s + '</option>';
      }).join('');
      if (stores.length > 0 && !sel.value) sel.value = stores[0];
    }

    initStoreSelect();
    renderDayTabs();
  </script>
  <script src="export.js"></script>
</body>
</html>
